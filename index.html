<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ローカルHTML + 複数CSS/JS 実行プレビュー（CSSボックスモデル可視化付き）</title>
<style>
  :root{ --bg:#0b1020; --panel:#12182b; --muted:#99a3b3; --border:#223; }
  *{ box-sizing:border-box; }
  body{ margin:0; min-height:100vh; display:grid; place-items:center; background:var(--bg); color:#e6ebf5; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif; }
  .card{ width:min(920px,92vw); background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
  h1{ font-size:18px; margin:0 0 10px; color:#cfe1ff; }
  p{ margin:0 0 14px; color:var(--muted); font-size:12px; }
  .inputs{ display:grid; grid-template-columns: 1fr; gap:10px; }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  label{ font-size:13px; width:160px; color:#cfe1ff; }
  input[type="file"], .btn{ background:#0f1527; color:#e6ebf5; border:1px solid #2a3552; border-radius:10px; padding:8px 10px; }
  input[type="file"]{ flex:1; }
  .btn{ cursor:pointer; font-weight:700; }
  .btn:hover{ border-color:#3b4b77; }
  .status{ margin-top:10px; font-size:12px; color:var(--muted); }
</style>
</head>
<body>
  <div class="card">
    <h1>ローカルHTML + 複数CSS/JS をアップロードして実行</h1>
    <p>HTMLを1つ、CSS/JSを複数選んで「新しいタブで表示」。開いたページへは <strong>DOM API で動的注入</strong> するため、タグ誤形成エラーを回避できます。</p>
    <div class="inputs">
      <div class="row">
        <label for="htmlFile">HTML（1個）</label>
        <input id="htmlFile" type="file" accept=".html,.htm,text/html" />
      </div>
      <div class="row">
        <label for="cssFiles">CSS（複数可）</label>
        <input id="cssFiles" type="file" accept=".css,text/css" multiple />
      </div>
      <div class="row">
        <label for="jsFiles">JavaScript（複数可）</label>
        <input id="jsFiles" type="file" accept=".js,application/javascript,text/javascript" multiple />
      </div>
      <div class="row">
        <button class="btn" id="btnOpen">新しいタブで表示 ⌘/Ctrl+Enter</button>
      </div>
      <div class="status" id="status">準備完了</div>
    </div>
  </div>

<script>
(function(){
  var htmlInput=document.getElementById('htmlFile');
  var cssInput=document.getElementById('cssFiles');
  var jsInput=document.getElementById('jsFiles');
  var btn=document.getElementById('btnOpen');
  var statusEl=document.getElementById('status');

  function status(msg){ statusEl.textContent=msg; }

  function readAsText(file){
    return new Promise(function(res,rej){
      var fr=new FileReader();
      fr.onload=function(){ res(String(fr.result||'')); };
      fr.onerror=function(){ rej(fr.error||new Error('read error')); };
      fr.readAsText(file);
    });
  }

  function wrapIfFragment(html){
    var s=String(html||'');
    if(/<html[\s>]/i.test(s)) return s;
    return '<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"></head><body>'+s+'</body></html>';
  }

  function createBoxModelOverlay(win){
    var doc=win.document;
    var overlay=doc.createElement('div'); overlay.id='__overlay'; overlay.style.cssText='position:fixed;left:0;top:0;width:100vw;height:100vh;pointer-events:none;z-index:2147483647'; doc.body.appendChild(overlay);
    function mk(bg,border){ var d=doc.createElement('div'); d.style.cssText='position:absolute;box-sizing:border-box;background:'+bg+';outline:'+border; return d; }
    var Lm=mk('rgba(255,200,0,.20)','1px dashed rgba(255,200,0,.7)'), Lb=mk('rgba(76,175,80,.20)','1px solid rgba(76,175,80,.7)'), Lp=mk('rgba(3,169,244,.20)','1px solid rgba(3,169,244,.7)'), Lc=mk('rgba(156,39,176,.08)','1px solid rgba(156,39,176,.7)');
    overlay.appendChild(Lm); overlay.appendChild(Lb); overlay.appendChild(Lp); overlay.appendChild(Lc);
    var tip=doc.createElement('div'); tip.id='__tip'; tip.style.cssText='position:fixed;min-width:220px;max-width:560px;background:#fff;color:#111;border:1px solid rgba(0,0,0,.15);border-radius:10px;padding:10px 12px;font:12px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;pointer-events:none;z-index:2147483647;box-shadow:0 8px 28px rgba(0,0,0,.25)'; doc.body.appendChild(tip);
    function px(n){return Math.max(0,Math.round(n))+'px';}
    function num(v){var x=parseFloat(v);return isNaN(x)?0:x;}
    function place(el,box){ el.style.left=px(box.left); el.style.top=px(box.top); el.style.width=px(Math.max(0,box.width)); el.style.height=px(Math.max(0,box.height)); }
    var current=null;
    function layout(t){ if(!t||!(t instanceof win.Element)) return; if(t.id&&t.id.indexOf('__')===0) return; var cs=win.getComputedStyle(t); var r=t.getBoundingClientRect(); var m={t:num(cs.marginTop),r:num(cs.marginRight),b:num(cs.marginBottom),l:num(cs.marginLeft)}; var b={t:num(cs.borderTopWidth),r:num(cs.borderRightWidth),b:num(cs.borderBottomWidth),l:num(cs.borderLeftWidth)}; var p={t:num(cs.paddingTop),r:num(cs.paddingRight),b:num(cs.paddingBottom),l:num(cs.paddingLeft)}; var marginBox={left:r.left-m.l,top:r.top-m.t,width:r.width+m.l+m.r,height:r.height+m.t+m.b}; var borderBox={left:r.left,top:r.top,width:r.width,height:r.height}; var padBox={left:r.left+b.l,top:r.top+b.t,width:r.width-b.l-b.r,height:r.height-b.t-b.b}; var contentBox={left:padBox.left+p.l,top:padBox.top+p.t,width:padBox.width-p.l-p.r,height:padBox.height-p.t-p.b}; place(Lm,marginBox); place(Lb,borderBox); place(Lp,padBox); place(Lc,contentBox); function row(o){return o.t+'|'+o.r+'|'+o.b+'|'+o.l;} var size=Math.round(r.width)+'×'+Math.round(r.height); var cont=Math.max(0,Math.round(contentBox.width))+'×'+Math.max(0,Math.round(contentBox.height)); var lines=['<strong>&lt;'+t.tagName.toLowerCase()+'&gt;</strong>', 'size <code>'+size+'</code> content <code>'+cont+'</code>', 'display: <code>'+cs.display+'</code>', 'position: <code>'+cs.position+'</code>', 'margin: <code>'+row(m)+'</code>', 'border-width: <code>'+row(b)+'</code>', 'padding: <code>'+row(p)+'</code>', 'font: <code>'+cs.fontSize+'/'+cs.lineHeight+'</code>', 'color: <code>'+cs.color+'</code> bg: <code>'+cs.backgroundColor+'</code>']; tip.innerHTML=lines.join('<br>'); }
    function moveTip(x,y){ var pad=18, vw=win.innerWidth, vh=win.innerHeight; tip.style.left=Math.min(vw-10, x+pad)+'px'; tip.style.top=Math.min(vh-10, y+pad)+'px'; }
    win.addEventListener('mousemove', function(e){ var el=doc.elementFromPoint(e.clientX,e.clientY); if(el!==current){ current=el; layout(el);} moveTip(e.clientX,e.clientY); }, {passive:true});
    win.addEventListener('scroll', function(){ if(current) layout(current); }, {passive:true});
    win.addEventListener('resize', function(){ if(current) layout(current); });
  }

  async function openPreview(){
    try{
      if(!htmlInput.files || htmlInput.files.length===0){ alert('HTMLファイルを1つ選択してください'); return; }
      if(htmlInput.files.length>1){ alert('HTMLは1つだけ選択してください'); return; }
      status('読み込み中…');
      var htmlText = await readAsText(htmlInput.files[0]);
      var cssTexts=[]; for(var i=0;i<(cssInput.files?cssInput.files.length:0);i++){ cssTexts.push(await readAsText(cssInput.files[i])); }
      var jsTexts=[]; for(var j=0;j<(jsInput.files?jsInput.files.length:0);j++){ jsTexts.push(await readAsText(jsInput.files[j])); }

      var docStr = wrapIfFragment(htmlText);
      var win = window.open('about:blank','_blank');
      if(!win){ alert('ポップアップがブロックされました'); status('ポップアップがブロックされました'); return; }

      // まず元のHTMLだけを書き込み
      win.document.open();
      win.document.write(docStr);
      win.document.close();

      // 読み込み完了後に DOM API で安全に注入
      var injectAll = function(){
        try{
          // CSS を順番に <style> 要素で注入
          for(var i=0;i<cssTexts.length;i++){
            var st = win.document.createElement('style');
            st.id = '__user_css_'+i;
            st.textContent = cssTexts[i];
            (win.document.head || win.document.documentElement).appendChild(st);
          }
          // JS を順番に <script> で注入
          for(var k=0;k<jsTexts.length;k++){
            var sc = win.document.createElement('script');
            sc.id = '__user_js_'+k;
            sc.textContent = jsTexts[k];
            (win.document.body || win.document.documentElement).appendChild(sc);
          }
          // 可視化オーバーレイ
          createBoxModelOverlay(win);
        }catch(e){ console.error(e); }
      };

      if(win.document.readyState === 'complete' || win.document.readyState === 'interactive'){
        injectAll();
      } else {
        win.addEventListener('DOMContentLoaded', injectAll);
      }

      status('新しいタブで表示しました');
    }catch(err){
      console.error(err);
      alert('読み込みに失敗：'+ (err && err.message ? err.message : err));
      status('エラーが発生しました');
    }
  }

  btn.addEventListener('click', openPreview);
  window.addEventListener('keydown', function(e){ if((e.metaKey||e.ctrlKey) && e.key==='Enter'){ openPreview(); }});
})();
</script>
</body>
</html>